#!/bin/bash

set -eu

THIS_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "${THIS_DIR}" || exit 1

TMPFILE="$(mktemp)"

bazel query 'kind(md_library, //...)' | LC_ALL=C sort >"${TMPFILE}"

OUTFILE='.workspace_contents/workspace_contents.bzl'

cat >"${OUTFILE}" <<EOF
"""Auto-generated bzl file."""

_WORKSPACE_CONTENTS = [
EOF

while read -r line; do
    echo "    \"${line}\"," >>"${OUTFILE}"
done <"${TMPFILE}"

cat >>"${OUTFILE}" <<EOF
]

def workspace_contents():
    return _WORKSPACE_CONTENTS
EOF

rm "${TMPFILE}"

bazel run //.workspace_contents:workspace_contents_summary -- "${@}"
